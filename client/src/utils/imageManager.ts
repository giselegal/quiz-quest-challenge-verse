
// Fallback images - usando placeholders ou imagens locais
export const fallbackImages = {
  default: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI0Y3RjJFOSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNCODlCN0EiPkltYWdlbSBOw6NvIERpc3BvbsOtdmVsPC90ZXh0Pjwvc3ZnPg==',
  logo: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752430327/LOGO_DA_MARCA_GISELE_l78gin.png'
};

// Novas imagens funcionais do Cloudinary (der8kogzu)
export const workingImages = {
  // Logo e introdução
  logo: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752430327/LOGO_DA_MARCA_GISELE_l78gin.png',
  introBg: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752443943/Gemini_Generated_Image_i5cst6i5cst6i5cs_fpoukb.png',
  
  // Antes e depois
  beforeAfter1: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752430348/MARIANGELA_-_ANTES_E_DEPOIS_ipuoap.png',
  beforeAfter2: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752430335/ADRIANA-_ANTES_E_DEPOIS_ttgifc.png',
  
  // Depoimentos
  testimonial1: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752430304/DEPOIMENTO_COM_IMAGEM_-_S?NIA_q0g9cq.png',
  testimonial2: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752430304/DEPOIMENTO_COM_IMAGEM_-_PATR?CIA_x0mhud.png',
  testimonial3: 'https://res.cloudinary.com/der8kogzu/image/upload/v1752430304/DEPOIMENTO_COM_IMAGEM_-_MARIANGELA_sj7lki.png',
  
  // Questões estratégicas
  strategicImages: [
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430327/MULHER_ELEGANTE_COM_GUIA_DE_ESTILO_euxps7.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430327/MULHER_FRUSTRADA_NA_FRENTE_DO_GUARDA-ROUPA_jnrwcr.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430326/MOCKUPS_DE_TODOS_OS_PRODUTOS_-_GUIAS_DE_ESILOS_E_B?NUS_legwsb.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430303/COMPRAS_COMPULSIVAS_X_DIRE??O_COM_O_GUIA_DE_ESTILO_xy0hb3.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430348/IMANGES_MULHERES_8_ESTILOS_UNIVERSAIS_blvkgv.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430348/MULHER_SEM_ESTILO_E_PERDIDA_HH_0TRK1A_hse63r.png'
  ],
  
  // Questão 1
  q1: [
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430262/Q1_-_A_xlh5cg.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430263/Q1_-_B_bm79bg.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430262/Q1_-_C_n2at5j.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430264/Q1_-_D_psbhs9.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430272/Q1_-_E_pwhukq.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430272/Q1_-_F_z1nyug.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430268/Q1_-_G_zgy8mq.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430269/Q1_-_H_dqhkzv.png'
  ],
  
  // Questão 2
  q2: [
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430272/Q3_-_A_plsfwp.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430270/Q3_-_B_w75tyg.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430270/Q3_-_C_ep9x9h.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430271/Q3_-_D_xxra9m.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430278/Q3_-_E_lr9p2d.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430280/Q3_-_F_amdr7l.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430279/Q3_-_G_zod0w5.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430276/Q3_-_H_aghfg8.png'
  ],
  
  // Questão 4
  q4: [
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430276/Q4_-_A_k6gvtc.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430277/Q4_-_B_a1emi6.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430277/Q4_-_C_ywcxcx.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430277/Q4_-_D_y7u29d.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430277/Q4_-_E_gnuvl3.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430291/Q4_-_F_lzrw2j.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430289/Q4_-_G_vr81is.png',
    'https://res.cloudinary.com/der8kogzu/image/upload/v1752430290/Q4_-_H_yjbt0s.png'
  ]
};

/**
 * Mapeamento de imagens quebradas para imagens funcionais
 */
const brokenToWorkingImageMap: Record<string, string> = {
  // Questão 1 - mapear imagens numeradas antigas para novas
  '14_l2nprc.webp': workingImages.q1[0],
  '4_snhaym.webp': workingImages.q1[1], 
  '15_xezvcy.webp': workingImages.q1[2],
  '16_mpqpew.webp': workingImages.q1[3],
  '11_hqmr8l.webp': workingImages.q1[4],
  '12_edlmwf.webp': workingImages.q1[5],
  '18_j8ipfb.webp': workingImages.q1[6],
  '17_m5ogub.webp': workingImages.q1[7],
  
  // Questão 2
  '2_ziffwx.webp': workingImages.q3[0],
  '5_dhrgpf.webp': workingImages.q3[1],
  '9_x6so6a.webp': workingImages.q3[2],
  '7_ynez1z.webp': workingImages.q3[3],
  '13_uvbciq.webp': workingImages.q3[4],
  '3_asaunw.webp': workingImages.q3[5],
  '6_gnoxfg.webp': workingImages.q3[6],
  '8_yqu3hw.webp': workingImages.q3[7],
  
  // Questões mais avançadas
  '20_oh44vh.webp': workingImages.q4[0],
  '21_o7wkte.webp': workingImages.q4[1],
  '26_dptanw.webp': workingImages.q4[2],
  '23_bdfxrh.webp': workingImages.q4[3],
  '22_siebw2.webp': workingImages.q4[4],
  '24_nptszu.webp': workingImages.q4[5],
  '25_motk6b.webp': workingImages.q4[6],
  '27_wxmklx.webp': workingImages.q4[7],
  
  // Logo
  'logo.webp': workingImages.logo,
  'LOGO_DA_MARCA_GISELE': workingImages.logo
};

/**
 * Função para substituir URLs quebradas do Cloudinary por imagens funcionais
 */
export const getImageUrlWithFallback = (originalUrl: string): string => {
  if (!originalUrl) return fallbackImages.default;
  
  // Se for uma URL do Cloudinary quebrada (dqljyf76t)
  if (originalUrl.includes('res.cloudinary.com/dqljyf76t')) {
    // Extrair o nome do arquivo
    const fileName = originalUrl.split('/').pop()?.split('.')[0];
    
    // Procurar no mapeamento
    for (const [brokenKey, workingUrl] of Object.entries(brokenToWorkingImageMap)) {
      if (originalUrl.includes(brokenKey) || fileName?.includes(brokenKey.split('.')[0])) {
        console.log(`✅ Mapped broken image: ${brokenKey} -> ${workingUrl}`);
        return workingUrl;
      }
    }
    
    // Se não encontrou no mapa, usar uma imagem estratégica aleatória
    const randomStrategic = workingImages.strategicImages[Math.floor(Math.random() * workingImages.strategicImages.length)];
    console.warn(`⚠️ Using random strategic image for: ${originalUrl}`);
    return randomStrategic;
  }
  
  // Se for logo.webp
  if (originalUrl.includes('logo.webp')) {
    return workingImages.logo;
  }
  
  return originalUrl;
};

interface ImageMetadata {
  width?: number;
  height?: number;
  alt?: string;
  loaded?: boolean;
}

const imageCache = new Map<string, ImageMetadata>();

export const preloadImage = (src: string): Promise<void> => {
  const safeSrc = getImageUrlWithFallback(src);
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      imageCache.set(src, {
        width: img.naturalWidth,
        height: img.naturalHeight,
        loaded: true,
        alt: `Image ${src}`
      });
      resolve();
    };
    img.onerror = () => {
      console.warn(`Failed to preload image: ${src}`);
      // Não rejeitamos para não quebrar o resto da aplicação
      resolve();
    };
    img.src = safeSrc;
  });
};

export const preloadImages = (urls: string[]): Promise<void[]> => {
  return Promise.all(urls.map(preloadImage));
};

export const getOptimizedImageUrl = (src: string, options?: { width?: number; height?: number; quality?: number; format?: string }): string => {
  // Simple implementation - in a real app, this would handle Cloudinary transformations
  return src;
};

export const getLowQualityPlaceholder = (src: string): string => {
  // Simple implementation - in a real app, this would generate a low-quality placeholder
  return src;
};

export const preloadCriticalImages = (urls: string[]): Promise<void[]> => {
  return preloadImages(urls);
};

export const preloadImagesByUrls = (urls: string[]): Promise<void[]> => {
  return preloadImages(urls);
};

export const getImageMetadata = (src: string): ImageMetadata => {
  return imageCache.get(src) || { width: undefined, height: undefined, alt: undefined, loaded: false };
};

export const isImagePreloaded = (src: string): boolean => {
  const metadata = imageCache.get(src);
  return metadata?.loaded || false;
};

export const getOptimizedImage = (src: string, options?: { width?: number; height?: number; quality?: number; format?: string }): string => {
  return getOptimizedImageUrl(src, options);
};
